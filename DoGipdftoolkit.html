<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoGi PDF Hub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Libraries (pdf-lib & pdf.js) -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style for file drag-and-drop area */
        .drop-zone {
            border: 2px dashed #475569;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone.drag-over {
            background-color: #334155;
            border-color: #6366f1;
        }
        /* Simple animation for tool cards */
        .tool-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2), 0 4px 6px -2px rgba(99, 102, 241, 0.1);
        }
        /* Page thumbnail styles */
        .page-thumbnail {
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .page-thumbnail.selected {
            border-color: #6366f1;
        }
        .page-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            font-weight: bold;
        }
        .page-thumbnail:hover .page-overlay {
            opacity: 1;
        }
        .page-thumbnail canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        /* For Gemini Summary Output */
        #gemini-summary {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 antialiased">

    <!-- Loading Spinner -->
    <div id="loader" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loader-text" class="mt-4 text-white">Processing...</p>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div id="app-container" class="min-h-screen p-4 sm:p-6 lg:p-8">

        <!-- Home View: Grid of Tools -->
        <div id="home-view">
            <header class="text-center mb-10">
                <h1 class="text-4xl sm:text-5xl font-bold text-white">DoGi PDF Hub</h1>
                <p class="mt-4 text-lg text-slate-400 max-w-2xl mx-auto">A suite of powerful, client-side tools to handle your PDF needs with privacy and speed.âœ¨</p>
            </header>
            
            <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
                <!-- Tool Cards will be inserted here by JavaScript -->
            </main>

            <!-- About Us Section START -->
            <section id="about-us" class="max-w-7xl mx-auto mt-20 py-10 text-center border-t border-slate-700/50">
                <h2 class="text-3xl font-bold text-white mb-4">About DoGi PDF Hub</h2>
                <p class="text-lg text-slate-400 max-w-3xl mx-auto mb-12">
                    DoGi PDF Hub was created to provide a fast, free, and secure way to manage your PDF files. All processing happens directly in your browser, meaning your files never leave your computer. you uses smart features like document summarization and title suggestions, making your workflow even more efficient.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                    <div class="bg-slate-800 p-6 rounded-lg transform transition-transform hover:scale-105">
                        <h3 class="text-xl font-semibold text-white mb-2">ðŸ”’ Completely Private</h3>
                        <p class="text-slate-400">Your files are processed on your device, not on our servers. We never see or store your data, ensuring your information remains confidential.</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-lg transform transition-transform hover:scale-105">
                        <h3 class="text-xl font-semibold text-white mb-2">âš¡ Blazing Fast</h3>
                        <p class="text-slate-400">By leveraging your browser's power, we eliminate slow upload times and deliver your processed files back to you almost instantly.</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-lg transform transition-transform hover:scale-105">
                        <h3 class="text-xl font-semibold text-white mb-2">âœ¨ AI-Powered</h3>
                        <p class="text-slate-400">With AI, you can unlock deeper insights from your documents without compromising privacy or security. Summarize text in seconds!</p>
                    </div>
                </div>
            </section>
            <!-- About Us Section END -->
        </div>

        <!-- Tool View: For individual tools -->
        <div id="tool-view" class="hidden max-w-5xl mx-auto">
            <header class="flex items-center mb-8">
                <button id="back-btn" class="p-2 rounded-full hover:bg-slate-700 transition-colors mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                </button>
                <div>
                    <h2 id="tool-title" class="text-3xl font-bold text-white">Tool Title</h2>
                    <p id="tool-description" class="mt-1 text-slate-400">Tool description.</p>
                </div>
            </header>
            
            <main id="tool-workspace">
                <!-- File Drop Zone -->
                <div id="drop-zone-container">
                    <div id="drop-zone" class="drop-zone rounded-lg p-10 text-center cursor-pointer bg-slate-800 hover:bg-slate-700/50">
                        <div class="flex flex-col items-center justify-center space-y-4">
                            <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <p class="text-lg font-medium text-slate-300">Drag & drop files here, or click to select</p>
                            <p id="file-type-info" class="text-sm text-slate-500">Supported files: PDF, JPG, PNG</p>
                        </div>
                        <input type="file" id="file-input" class="hidden">
                    </div>
                </div>

                <!-- File List & Options -->
                <div id="file-list-container" class="mt-6 hidden">
                     <h3 class="text-lg font-semibold text-white mb-2">Your Files:</h3>
                     <div id="file-list" class="space-y-2"></div>
                </div>
                
                <div id="tool-options" class="mt-6">
                    <!-- Tool specific options will be rendered here -->
                </div>
                
                <!-- Action Button -->
                <div id="action-button-container" class="mt-8 text-center hidden">
                     <button id="process-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105 disabled:bg-slate-600 disabled:cursor-not-allowed disabled:scale-100">
                         Process Files
                     </button>
                </div>

                <!-- Result View -->
                <div id="result-view" class="mt-8 hidden">
                    <h3 class="text-2xl font-bold text-white mb-4 text-center">Success!</h3>
                    <div id="download-container" class="text-center">
                        <p class="text-slate-400 mb-6">Your file is ready for download.</p>
                        <!-- Download links will be added here -->
                    </div>
                    <div id="gemini-result-container" class="hidden">
                         <div class="bg-slate-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-lg font-semibold text-white">AI Summary</h4>
                                <button id="copy-summary-btn" class="bg-slate-700 hover:bg-slate-600 text-sm text-white font-semibold py-1 px-3 rounded-md flex items-center transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                    Copy
                                </button>
                            </div>
                            <p id="gemini-summary" class="bg-slate-900 rounded-md p-3 text-slate-300 max-h-96 overflow-y-auto"></p>
                         </div>
                    </div>
                    <div class="text-center">
                       <button id="reset-btn" class="mt-6 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Start Over</button>
                    </div>
                </div>
            </main>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        
        // Configure pdf.js worker
        if (typeof pdfjsLib === 'undefined') {
            console.error("pdf.js library not loaded.");
            return;
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js`;

        // --- DOM Elements ---
        const homeView = document.getElementById('home-view');
        const toolView = document.getElementById('tool-view');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const backBtn = document.getElementById('back-btn');
        const toolTitle = document.getElementById('tool-title');
        const toolDescription = document.getElementById('tool-description');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileTypeInfo = document.getElementById('file-type-info');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const toolOptions = document.getElementById('tool-options');
        const actionButtonContainer = document.getElementById('action-button-container');
        const processBtn = document.getElementById('process-btn');
        const resultView = document.getElementById('result-view');
        const downloadContainer = document.getElementById('download-container');
        const geminiResultContainer = document.getElementById('gemini-result-container');
        const geminiSummary = document.getElementById('gemini-summary');
        const copySummaryBtn = document.getElementById('copy-summary-btn');
        const resetBtn = document.getElementById('reset-btn');
        const dropZoneContainer = document.getElementById('drop-zone-container');
        
        // --- App State ---
        let currentTool = null;
        let uploadedFiles = [];

        // --- Tool Definitions ---
        const tools = {
            'images-to-pdf': {
                title: 'Images to PDF',
                description: 'Convert JPG and PNG images into a PDF file.',
                accept: 'image/jpeg, image/png',
                multiple: true,
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path></svg>`,
                processFunction: imagesToPdf
            },
            'pdf-to-images': {
                title: 'PDF to Images',
                description: 'Extract all pages from a PDF as JPG images.',
                accept: '.pdf',
                multiple: false,
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m3 12 3-3 4 4 3-3 4 4"></path></svg>`,
                processFunction: pdfToImages,
            },
            'summarize-pdf': {
                title: 'Summarize PDF âœ¨',
                description: 'Use AI to analyze and generate a concise summary of your PDF file.',
                accept: '.pdf',
                multiple: false,
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><path d="m13 14-2-2 2-2"></path><path d="m7 14-2-2 2-2"></path><path d="M15 18H9"></path></svg>`,
                processFunction: summarizePdf
            },
            'merge-pdf': {
                title: 'Merge PDF',
                description: 'Combine multiple PDF files into a single document.',
                accept: '.pdf',
                multiple: true,
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>`,
                processFunction: mergePdfs,
                renderOptions: renderMergeOptions,
            },
            
            'split-pdf': {
                title: 'Split PDF',
                description: 'Extract a range of pages from a PDF file.',
                accept: '.pdf',
                multiple: false,
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="3" y1="12" x2="21" y2="12"></line></svg>`,
                processFunction: splitPdf,
                renderOptions: renderSplitOptions
            },
            'rotate-pdf': {
                title: 'Rotate PDF',
                description: 'Rotate pages in a PDF file individually.',
                accept: '.pdf',
                multiple: false,
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="M22 12h-2.5"></path><path d="M4.5 12H2"></path><path d="m16.2 7.8-.9-1.6"></path><path d="m8.7 17.8-.9-1.6"></path><path d="M12 4.5V2"></path><path d="M12 22v-2.5"></path><path d="m7.8 7.8-1.6-.9"></path><path d="m17.8 16.2-1.6-.9"></path></svg>`,
                processFunction: rotatePdf,
                onFileLoad: renderPdfThumbnails,
            },
            
            'add-page-numbers': {
                title: 'Add Page Numbers',
                description: 'Insert page numbers into your PDF file.',
                accept: '.pdf',
                multiple: false,
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18h.01"></path><path d="M10 18h.01"></path><path d="M14 18h.01"></path></svg>`,
                processFunction: addPageNumbers,
                renderOptions: renderPageNumberOptions,
            }
        };

        // --- UI Functions ---
        
        function showLoader(show, text = 'Processing...') {
            loaderText.textContent = text;
            loader.classList.toggle('hidden', !show);
        }

        function showView(view) {
            homeView.classList.toggle('hidden', view !== 'home');
            toolView.classList.toggle('hidden', view !== 'tool');
        }
        
        function resetToolState() {
            uploadedFiles = [];
            fileList.innerHTML = '';
            fileListContainer.classList.add('hidden');
            actionButtonContainer.classList.add('hidden');
            resultView.classList.add('hidden');
            geminiResultContainer.classList.add('hidden');
            downloadContainer.classList.add('hidden');
            downloadContainer.innerHTML = '';
            toolOptions.innerHTML = '';
            dropZoneContainer.classList.remove('hidden');
            fileInput.value = '';
        }

        function setupToolView(toolKey) {
            currentTool = tools[toolKey];
            resetToolState();
            
            toolTitle.textContent = currentTool.title;
            toolDescription.textContent = currentTool.description;
            fileInput.accept = currentTool.accept;
            fileInput.multiple = currentTool.multiple;
            fileTypeInfo.textContent = `Supported files: ${currentTool.accept}`;
            processBtn.textContent = currentTool.title.replace('âœ¨','').trim();
            
            if (currentTool.renderOptions) {
                currentTool.renderOptions();
            }
            
            showView('tool');
        }
        
        function renderFileList() {
            fileList.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between bg-slate-800 p-2 rounded-md';
                fileElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-indigo-400 mr-2">${index + 1}.</span>
                        <span class="text-slate-300 truncate max-w-xs sm:max-w-md">${file.name}</span>
                        <span class="text-slate-500 text-sm ml-2 flex-shrink-0">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </div>
                    <button data-index="${index}" class="remove-file-btn p-1 rounded-full hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                `;
                fileList.appendChild(fileElement);
            });

            if (uploadedFiles.length > 0) {
                fileListContainer.classList.remove('hidden');
                actionButtonContainer.classList.remove('hidden');
                // Enable suggest title button if it exists
                const suggestBtn = document.getElementById('suggest-title-btn');
                if (suggestBtn) suggestBtn.disabled = false;
            } else {
                fileListContainer.classList.add('hidden');
                actionButtonContainer.classList.add('hidden');
            }
        }
        
        function handleFileSelection(files) {
            if (currentTool.multiple) {
                uploadedFiles.push(...files);
            } else {
                uploadedFiles = [files[0]];
            }
            renderFileList();
            if (currentTool.onFileLoad) {
                currentTool.onFileLoad(uploadedFiles);
            }
        }
        
        function createDownloadLink(blob, filename) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.className = 'inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all transform hover:scale-105 m-2';
            a.textContent = `Download ${filename}`;
            downloadContainer.appendChild(a);
        }

        // --- Tool Specific UI ---
        function renderMergeOptions() {
            toolOptions.innerHTML = `
                <div class="bg-slate-800 p-4 rounded-lg">
                    <label for="merged-filename" class="block text-sm font-medium text-slate-300 mb-2">Output Filename</label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="merged-filename" class="w-full bg-slate-700 text-white border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="merged.pdf">
                        <button id="suggest-title-btn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-md shadow-lg flex-shrink-0 disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>
                            âœ¨ Suggest Title
                        </button>
                    </div>
                </div>`;
        }
        
        function renderSplitOptions() {
            toolOptions.innerHTML = `
                <div class="bg-slate-800 p-4 rounded-lg">
                    <label for="page-range" class="block text-sm font-medium text-slate-300 mb-2">Pages to Extract</label>
                    <input type="text" id="page-range" class="w-full bg-slate-700 text-white border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 1-3, 5, 8-10">
                    <p class="text-xs text-slate-500 mt-1">Use commas to separate pages or ranges (e.g., 1, 3-5).</p>
                </div>
            `;
        }
        
        function renderPageNumberOptions() {
            toolOptions.innerHTML = `
                <div class="bg-slate-800 p-4 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="page-number-position" class="block text-sm font-medium text-slate-300 mb-2">Position</label>
                        <select id="page-number-position" class="w-full bg-slate-700 text-white border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                            <option value="bottom-center" selected>Bottom Center</option>
                            <option value="bottom-left">Bottom Left</option>
                            <option value="bottom-right">Bottom Right</option>
                            <option value="top-center">Top Center</option>
                            <option value="top-left">Top Left</option>
                            <option value="top-right">Top Right</option>
                        </select>
                    </div>
                    <div>
                        <label for="page-number-start" class="block text-sm font-medium text-slate-300 mb-2">Start Numbering at</label>
                        <input type="number" id="page-number-start" value="1" min="1" class="w-full bg-slate-700 text-white border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
            `;
        }

        async function renderPdfThumbnails(files) {
            if (!files || files.length === 0) return;
            const file = files[0];
            const arrayBuffer = await file.arrayBuffer();

            showLoader(true, 'Generating Previews...');
            toolOptions.innerHTML = `<div id="thumbnail-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>`;
            const thumbnailGrid = document.getElementById('thumbnail-grid');
            thumbnailGrid.dataset.rotations = JSON.stringify({});

            try {
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 });
                    
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const context = canvas.getContext('2d');
                    
                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    const thumbnailContainer = document.createElement('div');
                    thumbnailContainer.className = 'page-thumbnail group';
                    thumbnailContainer.dataset.pageNum = i;
                    thumbnailContainer.innerHTML = `
                        ${canvas.outerHTML}
                        <div class="page-overlay flex-col">
                            <span>Page ${i}</span>
                            <div class="mt-2 flex space-x-2">
                                <button data-direction="left" class="rotate-btn p-1 bg-black/50 rounded-full hover:bg-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg></button>
                                <button data-direction="right" class="rotate-btn p-1 bg-black/50 rounded-full hover:bg-indigo-600"><path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/></svg></button>
                            </div>
                        </div>
                    `;
                    thumbnailGrid.appendChild(thumbnailContainer);
                }
            } catch (e) {
                console.error(e);
                alert('Error loading PDF for preview.');
            } finally {
                showLoader(false);
            }
        }
        
        // --- Gemini & PDF Text Extraction ---
        async function callGemini(prompt, retries = 3, delay = 1000) {
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) { // Throttling
                        await new Promise(res => setTimeout(res, delay));
                        return callGemini(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response from AI.";
            } catch (error) {
                 if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGemini(prompt, retries - 1, delay * 2);
                }
                console.error("Error calling Gemini API:", error);
                return "Failed to get response from AI after multiple attempts.";
            }
        }

        async function extractTextFromPdf(file, pageLimit = 0) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const numPages = pageLimit > 0 ? Math.min(pageLimit, pdf.numPages) : pdf.numPages;
            let fullText = '';

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            return fullText;
        }

        // --- Core PDF Processing Functions ---

        async function summarizePdf() {
            showLoader(true, 'Reading PDF...');
            const file = uploadedFiles[0];
            const pdfText = await extractTextFromPdf(file);

            if (!pdfText.trim()) {
                alert("Could not extract any text from this PDF.");
                showLoader(false);
                return;
            }
            
            showLoader(true, 'Generating summary with Gemini AI...');
            const prompt = `Please provide a concise, well-structured summary of the following document content:\n\n---\n\n${pdfText.substring(0, 10000)}`; // Limit text to avoid huge requests
            const summary = await callGemini(prompt);

            geminiSummary.textContent = summary;
            geminiResultContainer.classList.remove('hidden');
            downloadContainer.classList.add('hidden');
        }

        async function mergePdfs() {
            const mergedPdf = await PDFDocument.create();
            for (const file of uploadedFiles) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await PDFDocument.load(arrayBuffer);
                const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                copiedPages.forEach(page => mergedPdf.addPage(page));
            }
            const pdfBytes = await mergedPdf.save();
            const filenameInput = document.getElementById('merged-filename');
            let filename = (filenameInput && filenameInput.value) ? filenameInput.value : 'merged.pdf';
            if (!filename.toLowerCase().endsWith('.pdf')) {
                filename += '.pdf';
            }
            createDownloadLink(new Blob([pdfBytes], { type: 'application/pdf' }), filename);
            downloadContainer.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');
        }

        async function splitPdf() {
            const file = uploadedFiles[0];
            // ... (rest of the function is unchanged)
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await PDFDocument.load(arrayBuffer);
            
            const rangeInput = document.getElementById('page-range').value;
            const pageIndices = [];
            const ranges = rangeInput.split(',').map(s => s.trim());
            
            for (const range of ranges) {
                if (range.includes('-')) {
                    const [start, end] = range.split('-').map(Number);
                    for (let i = start; i <= end; i++) {
                        pageIndices.push(i - 1);
                    }
                } else {
                    pageIndices.push(Number(range) - 1);
                }
            }
            
            const uniqueIndices = [...new Set(pageIndices)].filter(i => i >= 0 && i < pdf.getPageCount());
            
            const splitPdfDoc = await PDFDocument.create();
            const copiedPages = await splitPdfDoc.copyPages(pdf, uniqueIndices);
            copiedPages.forEach(page => splitPdfDoc.addPage(page));
            
            const pdfBytes = await splitPdfDoc.save();
            createDownloadLink(new Blob([pdfBytes], { type: 'application/pdf' }), 'split.pdf');
            downloadContainer.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');
        }

        async function imagesToPdf() {
            // ... (unchanged)
            const pdfDoc = await PDFDocument.create();
            for (const file of uploadedFiles) {
                const arrayBuffer = await file.arrayBuffer();
                let image;
                if(file.type === 'image/png') {
                    image = await pdfDoc.embedPng(arrayBuffer);
                } else {
                    image = await pdfDoc.embedJpg(arrayBuffer);
                }
                const page = pdfDoc.addPage([image.width, image.height]);
                page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
            }
            const pdfBytes = await pdfDoc.save();
            createDownloadLink(new Blob([pdfBytes], { type: 'application/pdf' }), 'converted.pdf');
            downloadContainer.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');
        }

        async function rotatePdf() {
            // ... (unchanged)
            const rotations = JSON.parse(document.getElementById('thumbnail-grid').dataset.rotations);
            if (Object.keys(rotations).length === 0) {
                alert("No pages were rotated.");
                return;
            }

            const file = uploadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            const pages = pdfDoc.getPages();

            for (const [pageNum, angle] of Object.entries(rotations)) {
                const pageIndex = parseInt(pageNum) - 1;
                if (pages[pageIndex]) {
                    const currentRotation = pages[pageIndex].getRotation().angle;
                    pages[pageIndex].setRotation({ angle: currentRotation + angle });
                }
            }

            const pdfBytes = await pdfDoc.save();
            createDownloadLink(new Blob([pdfBytes], { type: 'application/pdf' }), 'rotated.pdf');
            downloadContainer.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');
        }

        async function pdfToImages() {
            // ... (unchanged)
            const file = uploadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const context = canvas.getContext('2d');
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;

                canvas.toBlob(blob => {
                    createDownloadLink(blob, `page_${i}.jpg`);
                }, 'image/jpeg', 0.9);
            }
            downloadContainer.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');
        }

        async function addPageNumbers() {
            // ... (unchanged)
            const file = uploadedFiles[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);

            const pages = pdfDoc.getPages();
            const startNum = parseInt(document.getElementById('page-number-start').value, 10) || 1;
            const position = document.getElementById('page-number-position').value;

            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                const pageNum = i + startNum;
                const { width, height } = page.getSize();
                
                let x, y;
                const margin = 50;
                
                switch (position) {
                    case 'bottom-left': x = margin; y = margin; break;
                    case 'bottom-right': x = width - margin; y = margin; break;
                    case 'top-center': x = width / 2; y = height - margin; break;
                    case 'top-left': x = margin; y = height - margin; break;
                    case 'top-right': x = width - margin; y = height - margin; break;
                    case 'bottom-center':
                    default: x = width / 2; y = margin; break;
                }

                page.drawText(String(pageNum), {
                    x, y, font: helveticaFont, size: 12, color: rgb(0, 0, 0),
                });
            }

            const pdfBytes = await pdfDoc.save();
            createDownloadLink(new Blob([pdfBytes], { type: 'application/pdf' }), 'paginated.pdf');
            downloadContainer.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');
        }

        async function suggestMergeTitle() {
            if (uploadedFiles.length === 0) return;
            showLoader(true, 'Reading files...');
            let combinedText = '';
            for (const file of uploadedFiles) {
                try {
                    const text = await extractTextFromPdf(file, 1); // Only first page
                    combinedText += `--- DOC: ${file.name} ---\n${text}\n\n`;
                } catch(e) {
                    console.warn(`Could not extract text from ${file.name}, skipping for title suggestion.`);
                }
            }

            if (!combinedText.trim()) {
                alert("Could not extract any text from the PDFs to suggest a title.");
                showLoader(false);
                return;
            }

            showLoader(true, 'Asking Gemini for title ideas...');
            const prompt = `Based on the content from the first pages of several documents, suggest a short, descriptive filename (without the .pdf extension, using underscores instead of spaces). The filename should be 1-5 words long. Here is the content:\n\n${combinedText.substring(0, 8000)}`;
            const suggestedTitle = await callGemini(prompt);
            
            const filenameInput = document.getElementById('merged-filename');
            if (filenameInput) {
                // Clean up the response to be a valid filename
                filenameInput.value = suggestedTitle.replace(/[\"\'\.\s]/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
            }
            showLoader(false);
        }

        // --- Event Handlers ---
        
        async function handleProcess() {
            if (!currentTool || !currentTool.processFunction) return;
            
            showLoader(true);
            try {
                await currentTool.processFunction();
                resultView.classList.remove('hidden');
                dropZoneContainer.classList.add('hidden');
                fileListContainer.classList.add('hidden');
                actionButtonContainer.classList.add('hidden');
                toolOptions.classList.add('hidden');

            } catch (error) {
                console.error(error);
                alert(`An error occurred: ${error.message}`);
            } finally {
                showLoader(false);
            }
        }
        
        backBtn.addEventListener('click', () => showView('home'));
        resetBtn.addEventListener('click', () => setupToolView(Object.keys(tools).find(key => tools[key] === currentTool)));
        
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFileSelection(Array.from(e.target.files)));
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); });
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
        });
        dropZone.addEventListener('drop', (e) => {
            handleFileSelection(Array.from(e.dataTransfer.files));
        });

        fileList.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-file-btn');
            if (removeBtn) {
                const index = parseInt(removeBtn.dataset.index, 10);
                uploadedFiles.splice(index, 1);
                renderFileList();
            }
        });
        
        processBtn.addEventListener('click', handleProcess);

        toolOptions.addEventListener('click', e => {
            // Event delegation for rotate buttons
            const rotateBtn = e.target.closest('.rotate-btn');
            if (rotateBtn) {
                const direction = rotateBtn.dataset.direction;
                const thumbnailContainer = rotateBtn.closest('.page-thumbnail');
                const pageNum = thumbnailContainer.dataset.pageNum;
                const canvas = thumbnailContainer.querySelector('canvas');
                
                const thumbnailGrid = document.getElementById('thumbnail-grid');
                const rotations = JSON.parse(thumbnailGrid.dataset.rotations);

                const angle = direction === 'right' ? 90 : -90;
                rotations[pageNum] = (rotations[pageNum] || 0) + angle;

                canvas.style.transform = `rotate(${rotations[pageNum]}deg)`;
                thumbnailGrid.dataset.rotations = JSON.stringify(rotations);
                return;
            }
            
            // Event delegation for suggest title button
            const suggestBtn = e.target.closest('#suggest-title-btn');
            if (suggestBtn) {
                suggestMergeTitle();
            }
        });

        copySummaryBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(geminiSummary.textContent).then(() => {
                copySummaryBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copySummaryBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy`;
                }, 2000);
            });
        });
        
        // --- Initialization ---
        
        function init() {
            const mainGrid = homeView.querySelector('main');
            // Use Object.entries to guarantee order if needed, or just loop keys
            Object.keys(tools).forEach(key => {
                const tool = tools[key];
                const card = document.createElement('div');
                card.className = 'tool-card bg-slate-800 p-6 rounded-lg shadow-lg cursor-pointer flex flex-col items-center text-center';
                card.dataset.tool = key;
                card.innerHTML = `
                    <div class="text-indigo-400 mb-4">${tool.icon}</div>
                    <h3 class="text-xl font-bold text-white mb-2">${tool.title}</h3>
                    <p class="text-slate-400 text-sm flex-grow">${tool.description}</p>
                `;
                card.addEventListener('click', () => setupToolView(key));
                mainGrid.appendChild(card);
            });
        }
        
        init();
    });
    </script>
</body>
</html>


